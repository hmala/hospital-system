# نظام اختيار التحاليل والأشعة في الاستعلامات

## نظرة عامة
تم تحديث نظام الاستعلامات لدعم اختيار أنواع التحاليل والأشعة المطلوبة بشكل تفصيلي قبل تحويل المريض للكاشير.

## الميزات الجديدة

### 1. اختيار أنواع التحاليل
عند اختيار خدمة "تحاليل طبية":
- ✅ يظهر نموذج مع قائمة كاملة بجميع أنواع التحاليل المتاحة
- ✅ التحاليل مقسمة حسب الفئات (كيمياء سريرية، أمراض الدم، إلخ)
- ✅ يمكن اختيار أكثر من تحليل واحد
- ✅ عداد يظهر عدد التحاليل المختارة
- ✅ التحقق من اختيار تحليل واحد على الأقل قبل الإرسال

### 2. اختيار أنواع الأشعة
عند اختيار خدمة "الأشعة":
- ✅ يظهر نموذج مع قائمة كاملة بجميع أنواع الأشعة المتاحة
- ✅ الأشعة مقسمة حسب الفئات (أشعة عادية، مقطعية، رنين مغناطيسي، إلخ)
- ✅ يمكن اختيار أكثر من نوع إشعة واحد
- ✅ عداد يظهر عدد أنواع الأشعة المختارة
- ✅ التحقق من اختيار نوع إشعة واحد على الأقل قبل الإرسال

### 3. التحديثات على نظام الكشف الطبي
- ✅ لم يتغير، يعمل كما كان سابقاً (اختيار طبيب وعيادة وتاريخ)
- ✅ يتم حجز موعد مباشرة ثم تحويل المريض للكاشير

## سير العمل

### سيناريو 1: طلب تحاليل
1. الموظف في الاستعلامات يختار المريض
2. يختار نوع الخدمة: "تحاليل طبية"
3. **الجديد:** يظهر نموذج باختيار أنواع التحاليل
4. يختار التحاليل المطلوبة (مثل: صورة دم كاملة، تحليل سكر، إلخ)
5. يضيف وصف للحالة
6. يرسل الطلب
7. **النظام ينشئ:**
   - زيارة في قسم الاستعلامات
   - طلب طبي يحتوي على أنواع التحاليل المختارة
   - رسالة توجيه للمريض للذهاب للكاشير

### سيناريو 2: طلب أشعة
1. الموظف في الاستعلامات يختار المريض
2. يختار نوع الخدمة: "الأشعة"
3. **الجديد:** يظهر نموذج باختيار أنواع الأشعة
4. يختار أنواع الأشعة المطلوبة (مثل: أشعة صدر، أشعة مقطعية، إلخ)
5. يضيف وصف للحالة
6. يرسل الطلب
7. **النظام ينشئ:**
   - زيارة في قسم الاستعلامات
   - طلب طبي يحتوي على أنواع الأشعة المختارة
   - رسالة توجيه للمريض للذهاب للكاشير

### سيناريو 3: حجز موعد كشف طبي
1. الموظف في الاستعلامات يختار المريض
2. يختار نوع الخدمة: "كشف طبي"
3. يختار الطبيب والعيادة
4. يحدد تاريخ الموعد (اختياري)
5. يرسل الطلب
6. **النظام ينشئ:**
   - موعد في نظام المواعيد
   - رسالة توجيه للمريض للذهاب للكاشير لدفع رسوم الكشف

## التغييرات التقنية

### 1. Controller: InquiryController.php
```php
// إضافة imports جديدة
use App\Models\LabTest;
use App\Models\RadiologyType;

// في دالة create()
$labTests = LabTest::where('is_active', true)
    ->orderBy('main_category')
    ->orderBy('name')
    ->get();

$radiologyTypes = RadiologyType::where('is_active', true)
    ->orderBy('main_category')
    ->orderBy('name')
    ->get();

// في دالة store()
// إضافة validation للحقول الجديدة
'lab_test_ids' => 'required_if:request_type,lab|array',
'radiology_type_ids' => 'required_if:request_type,radiology|array',

// حفظ البيانات في details
if ($requestType === 'lab' && $httpRequest->lab_test_ids) {
    $details['lab_test_ids'] = $httpRequest->lab_test_ids;
}

if ($requestType === 'radiology' && $httpRequest->radiology_type_ids) {
    $details['radiology_type_ids'] = $httpRequest->radiology_type_ids;
}
```

### 2. View: create.blade.php
```blade
<!-- حقول التحاليل -->
<div id="labFields" style="display: none;">
    @foreach($labTests->groupBy('main_category') as $category => $tests)
        <!-- قائمة checkboxes لكل تحليل -->
    @endforeach
</div>

<!-- حقول الأشعة -->
<div id="radiologyFields" style="display: none;">
    @foreach($radiologyTypes->groupBy('main_category') as $category => $types)
        <!-- قائمة checkboxes لكل نوع إشعة -->
    @endforeach
</div>
```

### 3. JavaScript
```javascript
// عرض/إخفاء الحقول حسب نوع الخدمة المختار
if (type === 'lab') {
    labFields.style.display = 'block';
} else if (type === 'radiology') {
    radiologyFields.style.display = 'block';
}

// تحديث العدادات
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('lab-test-checkbox')) {
        // تحديث عداد التحاليل
    }
    if (e.target.classList.contains('radiology-type-checkbox')) {
        // تحديث عداد الأشعة
    }
});
```

## قاعدة البيانات

### جداول مستخدمة:
- `lab_tests`: يحتوي على جميع أنواع التحاليل المتاحة
- `radiology_types`: يحتوي على جميع أنواع الأشعة المتاحة
- `requests`: يحفظ الطلبات مع التفاصيل في حقل `details` (JSON)

### بنية حقل details في جدول requests:
```json
{
  "created_by": 1,
  "created_at_inquiry": true,
  "auto_refer": false,
  "lab_test_ids": [1, 5, 12],  // للتحاليل
  "radiology_type_ids": [3, 7]  // للأشعة
}
```

## الخطوات التالية المقترحة

### في نظام الكاشير:
1. عرض تفاصيل التحاليل/الأشعة المختارة
2. حساب التكلفة الإجمالية بناءً على أسعار كل نوع
3. إنشاء فاتورة تفصيلية
4. تسجيل الدفع وتحديث حالة الطلب

### في نظام المختبر/الأشعة:
1. عرض الطلبات المدفوعة فقط
2. عرض قائمة التحاليل/الأشعة المطلوبة لكل مريض
3. إدخال النتائج لكل تحليل/إشعة
4. طباعة التقارير

## ملاحظات مهمة

⚠️ **التحقق من الدفع:**
- جميع الطلبات (تحاليل/أشعة/كشف) تتطلب دفع في الكاشير أولاً
- حالة الدفع مسجلة في جدول `appointments` أو `requests`

⚠️ **البيانات المطلوبة:**
- يجب أن تكون جداول `lab_tests` و `radiology_types` محدثة ونشطة
- يجب أن تكون الأسعار محددة لحساب التكلفة

⚠️ **واجهة المستخدم:**
- التصميم responsive ويعمل على جميع الأحجام
- استخدام checkboxes لسهولة الاختيار المتعدد
- عدادات توضح عدد العناصر المختارة

## الدعم والصيانة

للمزيد من المعلومات أو الإبلاغ عن مشاكل:
- راجع ملف `INQUIRY_SYSTEM_USAGE.md`
- راجع ملف `PAYMENT_SYSTEM_COMPLETE.md`

---
**آخر تحديث:** يناير 2026
**الإصدار:** 2.0
